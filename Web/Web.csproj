<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net462</TargetFramework>
    <RuntimeIdentifier>win7-x86</RuntimeIdentifier>
    <AssemblyName>Havit.NewProjectTemplate.Web</AssemblyName>
    <RootNamespace>Havit.NewProjectTemplate.Web</RootNamespace>
	<GenerateAssemblyInfo>false</GenerateAssemblyInfo>
	<TypeScriptCompileBlocked>true</TypeScriptCompileBlocked>
	<TypeScriptToolsVersion>Latest</TypeScriptToolsVersion>
  </PropertyGroup>

  <ItemGroup>
    <Compile Include="..\CommonAssemblyInfo.cs" Link="Properties\CommonAssemblyInfo.cs" />
  </ItemGroup>
  <ItemGroup>
	<DotNetCliToolReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Tools" Version="2.0.0" />
  </ItemGroup>
  
  <ItemGroup>
    <PackageReference Include="Havit.AspNetCore.Mvc" Version="1.7.2" />
    <PackageReference Include="Microsoft.ApplicationInsights.AspNetCore" Version="2.1.1" />
    <PackageReference Include="Microsoft.AspNetCore" Version="2.0.1" />
    <PackageReference Include="Microsoft.AspNetCore.Mvc" Version="2.0.2" />
    <PackageReference Include="Microsoft.AspNetCore.SpaServices" Version="2.0.2" />
    <PackageReference Include="Microsoft.AspNetCore.StaticFiles" Version="2.0.1" />
    <PackageReference Include="Microsoft.Extensions.Logging.EventLog" Version="2.0.0" />
    <PackageReference Include="Microsoft.VisualStudio.Web.BrowserLink">
      <Version>2.0.1</Version>
    </PackageReference>
    <PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design">
      <Version>2.0.2</Version>
    </PackageReference>
    <PackageReference Include="TypeLite.Lib">
      <Version>1.8.4</Version>
    </PackageReference>
  </ItemGroup>
    
  <Target Name="RunWebpack" BeforeTargets="Build"> 
	<!-- Ensure Node.js is installed -->
	<Exec Command="node --version" ContinueOnError="true">
	  <Output TaskParameter="ExitCode" PropertyName="ErrorCode" />
	</Exec>
	<Error Condition="'$(ErrorCode)' != '0'" Text="Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE." />

	<Message Importance="high" Text="Webpack build..." />
	
	<Exec Command="node node_modules/webpack/bin/webpack.js --config webpack.vendor.config.js" Condition=" '$(Configuration)' == 'Debug' " />
	<Exec Command="node node_modules/webpack/bin/webpack.js" Condition=" '$(Configuration)' == 'Debug' " />
  
	<!-- npm install nepouštíme v Debugu, neboť předpokládáme, že npm balíčky se při vývoji dostanou na disk díky IDE, které zpracovává package.json -->
	<Exec Command="npm install" Condition=" '$(Configuration)' != 'Debug' " />
	<Exec Command="node node_modules/webpack/bin/webpack.js --config webpack.vendor.config.js --env.prod" Condition=" '$(Configuration)' != 'Debug' " />
	<Exec Command="node node_modules/webpack/bin/webpack.js --env.prod" Condition=" '$(Configuration)' != 'Debug' " />
  </Target>

  <Target Name="PublishRunWebpack" AfterTargets="ComputeFilesToPublish">
    <!-- Include the built files in the publish output -->
	<ItemGroup>
	  <DistFiles Include="wwwroot\dist\**; ClientApp\dist\**" />
	  <ResolvedFileToPublish Include="@(DistFiles->'%(FullPath)')" Exclude="@(ResolvedFileToPublish)">
		<RelativePath>%(DistFiles.Identity)</RelativePath>
		<CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
	  </ResolvedFileToPublish>
	</ItemGroup>
  </Target>

  <Target Name="TfsPublish" AfterTargets="AfterPublish" Condition="'$(PublishDirectory)' != ''">
    <ItemGroup>
      <WebToCopy Include="obj\Release\TfsPublish\**\*.*" />
      <WebToCopy Remove="obj\Release\TfsPublish\Config\*.*" />
    </ItemGroup>
    <Copy SourceFiles="@(WebToCopy)" DestinationFiles="@(WebToCopy->'$(PublishDirectory)\Web\%(RecursiveDir)%(Filename)%(Extension)')" />
  </Target>

</Project>
